function t(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function e(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function i(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,a)}return i}function a(t){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?i(Object(n),!0).forEach((function(i){e(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var n=Object.freeze({cache:!0,base:"emoji",scale:.5,speed:10,density:3,staggered:!0,increaseSpeed:.08,emoji:null}),s=function(){function i(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,i),e(this,"options",void 0),e(this,"canvas",void 0),e(this,"ctx",void 0),e(this,"cacheCanvas",void 0),e(this,"cacheCanvasCtx",void 0),e(this,"_speed",void 0),e(this,"ratio",void 0),e(this,"emojis",void 0),e(this,"emojiImage",void 0),e(this,"hasLauched",void 0),e(this,"repeater",void 0),this.emojis=[],this.options=a(a({},n),t),this._speed=this.options.speed,this.init()}var s,h,o;return s=i,o=[{key:"getPixelRadio",value:function(){return window.devicePixelRatio||1}},{key:"rand",value:function(t){return Math.floor(Math.random()*t+1)}}],(h=[{key:"preloadImage",value:function(t){return new Promise((function(e,i){var a=new Image;a.src=t,a.complete?e(a):(a.onload=function(){e(a)},a.onerror=function(){i(a)})}))}},{key:"update",value:function(t){t&&(this.options=a(a({},this.options),t))}},{key:"createCacheCanvas",value:function(){this.cacheCanvas=document.createElement("canvas"),this.cacheCanvas.width=this.canvas.width,this.cacheCanvas.height=this.canvas.height,this.cacheCanvasCtx=this.cacheCanvas.getContext("2d")}},{key:"createEmojis",value:function(){var t=this;return this.options.emoji?this.preloadImage(this.options.emoji).then((function(e){t.emojiImage=e;for(var a=parseInt(t.canvas.style.width),n=a/e.width/t.options.scale*t.options.density,s=0;s<n;s++){var h=a/n*s*t.ratio,o=-i.rand(t.canvas.height);t.options.staggered&&(h=h*Math.random()*2);var r=i.rand(6)/10;r=r<.5?.8:r;var c={x:Math.trunc(.5+h),y:Math.trunc(.5+o),w:Math.trunc(.5+e.width*r),h:Math.trunc(.5+e.height*r),scale:t.options.scale,targetX:0};if(t.options.staggered){var d=0,u=t.canvas.width,v=u/3,l=u/3*2;if(h<v)d=h+1.2*u*Math.random();else if(h>l)d=h-1.2*u*Math.random();else{var p=Math.random();d=p<.5?v*p:u*Math.random()}c.targetX=Math.trunc(.5+d)}t.emojis.push(c)}})):Promise.reject(new Error("emoji图片不能为空"))}},{key:"drawStep",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);var t=!1,e=this.canvas.height;this._speed+=this.options.increaseSpeed,this.cacheCanvasCtx.clearRect(0,0,this.canvas.width,this.canvas.height);for(var i=0;i<this.emojis.length;i++){var a=this.emojis[i],n=.6*this._speed;a.y<e?(this.options.staggered&&(a.x<a.targetX?a.targetX-a.x<n?a.x=a.targetX:a.x+=n:a.x-a.targetX<n?a.x=a.targetX:a.x-=n),a.y+=this._speed,this.options.cache?this.cacheCanvasCtx.drawImage(this.emojiImage,Math.trunc(.5+a.x),Math.trunc(.5+a.y),Math.trunc(.5+a.w*a.scale),Math.trunc(.5+a.h*a.scale)):this.ctx.drawImage(this.emojiImage,Math.trunc(.5+a.x),Math.trunc(.5+a.y),Math.trunc(.5+a.w*a.scale),Math.trunc(.5+a.h*a.scale)),t=!0):this.emojis.splice(i,1)}t?this.options.cache&&this.ctx.drawImage(this.cacheCanvas,0,0,this.canvas.width,this.canvas.height):(this.hasLauched=!1,window.cancelAnimationFrame(this.repeater),this.options.onEnded&&this.options.onEnded())}},{key:"_launch",value:function(){this.hasLauched=!0,this.repeater=window.requestAnimationFrame(this._launch.bind(this)),this.drawStep()}},{key:"launch",value:function(){var t=this;this.hasLauched||this.createEmojis().then((function(){t.options.onStart&&t.options.onStart(),t._speed=t.options.speed,t._launch()}))}},{key:"init",value:function(){var t=this.options;this.canvas="string"==typeof t.base?document.querySelector(t.base):t.base,this.canvas.width=this.canvas.width||this.windowSize.width,this.canvas.height=this.canvas.height||this.windowSize.height,this.ctx=this.canvas.getContext("2d");var e=i.getPixelRadio();this.ratio=e,this.canvas.style.width=this.canvas.width+"px",this.canvas.style.height=this.canvas.height+"px",this.canvas.width*=e,this.canvas.height*=e,t.cache&&this.createCacheCanvas()}},{key:"windowSize",get:function(){return{width:document.documentElement.clientWidth,height:document.documentElement.clientHeight}}}])&&t(s.prototype,h),o&&t(s,o),i}();export default s;
